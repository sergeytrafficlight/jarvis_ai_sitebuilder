{% load i18n %}
<!-- Modal: –°–æ–∑–¥–∞—Ç—å —Å–∞–π—Ç -->
<div class="modal-overlay" id="{{modal_id}}">
    <div class="modal">
        <div class="modal-header">
            <h3>–°–æ–∑–¥–∞—Ç—å —Å–∞–π—Ç</h3>
            <button class="modal-close" id="createModalCloseBtn" aria-label="{% trans '–ó–∞–∫—Ä—ã—Ç—å' %}">‚úï</button>
        </div>
        <div class="modal-body two-columns">
            <div class="modal-left">
                <div class="form-group">
                    <label for="refUrl"><strong>{% trans "–£–∫–∞–∂–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å-—Å–∞–π—Ç" %}:</strong></label>
                    <input type="url" id="refUrl" placeholder="https://example.com" />
                    <div class="hint" id="refHint">{% trans "–†–µ—Ñ–µ—Ä–µ–Ω—Å-—Å–∞–π—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è" %}</div>
                    <div class="hint error" id="refError" style="display:none;"></div>
                    <div class="hint muted">{% trans "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –î–∞–Ω–Ω—ã–π —Å–∞–π—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –ø—Ä–∏–º–µ—Ä –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)" %}</div>
                </div>

                <div class="form-group">
                    <label for="taskPrompt"><strong>{% trans "–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å" %}</strong></label>

                    <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ -->
                    <div class="quick-actions" style="margin:6px 0 8px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button type="button" class="btn btn-secondary" id="promptQuickCopy">{% trans "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" %}</button>
                        <button type="button" class="btn btn-secondary" id="promptQuickCustom">{% trans "–°–≤–æ–π –ø—Ä–æ–º—Ç" %}</button>
                    </div>

                    <textarea id="taskPrompt" rows="7" placeholder="{% trans '–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–π —Å–∞–π—Ç –Ω—É–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å...'%}"></textarea>
                </div>

                <div class="form-group inline">
                    <label for="siteCount"><strong>{% trans "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∞–π—Ç–æ–≤" %}</strong></label>
                    <input type="number" id="siteCount" value="1" min="1" />
                </div>
            </div>

            <div class="modal-right">
                <div class="screenshot-box" id="screenshotBox">
                    <div class="gradient-loader" id="previewLoader" style="display:none;"></div>
                    <div class="preview-placeholder" id="previewNotUsed" >
                        <div class="placeholder-icon">üõà</div>
                        <div class="placeholder-text">{% trans "–†–µ—Ñ–µ—Ä–µ–Ω—Å-—Å–∞–π—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è" %}</div>
                    </div>

                    <div class="preview-placeholder error" id="previewErrorState" style="display:none;">
                        <div class="placeholder-icon">‚ö†</div>
                        <div class="placeholder-text">{% trans "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏" %}</div>
                    </div>

                    <div class="screenshot-scroll">
                        <img id="refPreview" alt="{% trans '–ü—Ä–µ–≤—å—é —Ä–µ—Ñ–µ—Ä–µ–Ω—Å-—Å–∞–π—Ç–∞' %}" />
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" id="startCreateBtn">{% trans '–°–æ–∑–¥–∞—Ç—å' %}</button>
            <button class="btn btn-secondary" id="cancelCreateBtn">{% trans '–û—Ç–º–µ–Ω–∞' %}</button>
        </div>
    </div>
</div>

<script>

let ref_url_typing_timer = null;
const ref_url_delay = 2000;
let lastController = null;
const imgLoading = "/static/img/loading.gif";
const imgError = "/static/img/error.png";
const imgNotUsed = "/static/img/not_used.png";

const refPreview = document.getElementById("refPreview");
const refError = document.getElementById("refError");
const refHint = document.getElementById("refHint");

const siteCountInput = document.getElementById("siteCount");
const startCreateBtn = document.getElementById("startCreateBtn");

// –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Ä–µ–∂–∏–º–æ–≤
const taskPromptEl = document.getElementById("taskPrompt");
const quickBtnCopy = document.getElementById("promptQuickCopy");
const quickBtnCustom = document.getElementById("promptQuickCustom");
const COPY_PROMPT_TEXT = "{% trans '–°–¥–µ–ª–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂—É—é –∫–æ–ø–∏—é –¥–∞–Ω–Ω–æ–≥–æ —Å–∞–π—Ç–∞' %}";
const DEFAULT_PLACEHOLDER_TEXT = taskPromptEl.getAttribute("placeholder") || "{% trans '–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–π —Å–∞–π—Ç –Ω—É–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å...' %}";

let quickMode = "custom";  // 'copy' | 'custom'
let screenshotOk = false;  // —É—Å–ø–µ—Ö –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ (–¥–ª—è —Ä–µ–∂–∏–º–∞ 'copy')

function hideAllStates() {
    document.getElementById("previewLoader").style.display = "none";
    document.getElementById("previewNotUsed").style.display = "none";
    document.getElementById("previewErrorState").style.display = "none";

    // –í—Å–µ–≥–¥–∞ —Å–∫—Ä—ã–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    refPreview.style.display = "none";
    refPreview.classList.remove("fade-in-loaded", "fade-in");
}

function loaderShow() {
    document.getElementById("previewLoader").style.display = "block";
    refPreview.style.opacity = "0";
}

function loaderHide() {
    document.getElementById("previewLoader").style.display = "none";
    refPreview.style.opacity = "1";
}

function applyState(classesToAdd, classesToRemove) {
    classesToAdd.forEach(c => refPreview.classList.add(c));
    classesToRemove.forEach(c => refPreview.classList.remove(c));
}

function showError(message) {
    refError.textContent = message;
    refError.style.display = "block";
}

function hideError() {
    refError.style.display = "none";
}

function updateCreateButtonState() {
    if (quickMode === "copy") {
        startCreateBtn.disabled = !screenshotOk;
    } else {
        startCreateBtn.disabled = false;
    }
}

function setPreviewLoading() {
    hideError();
    refHint.textContent = "{% trans '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é...' %}";
    screenshotOk = false;
    updateCreateButtonState();

    hideAllStates();
    document.getElementById("previewLoader").style.display = "block";
}

function setPreviewNotUsed() {
    hideError();
    refHint.textContent = "{% trans '–†–µ—Ñ–µ—Ä–µ–Ω—Å-—Å–∞–π—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è' %}";
    screenshotOk = false;
    updateCreateButtonState();

    hideAllStates();
    document.getElementById("previewNotUsed").style.display = "flex";
}

function setPreviewError(msg) {
    showError(msg);
    refHint.textContent = "{% trans '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–≤—å—é' %}";
    screenshotOk = false;
    updateCreateButtonState();

    // –°–∫—Ä—ã–≤–∞–µ–º –í–°–ï
    hideAllStates();

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –æ—à–∏–±–∫–∏
    const errBox = document.getElementById("previewErrorState");
    errBox.style.display = "flex";

    // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –ø—Ä–µ–≤—å—é –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    refPreview.src = "";
    refPreview.style.display = "none";
}

function setPreviewSuccess(url) {
    hideError();
    refHint.textContent = "";
    screenshotOk = true;
    hideAllStates();
    refPreview.style.display = "block";

    refPreview.onload = () => {
        refPreview.classList.add("fade-in-loaded");
    };

    refPreview.src = url;
    updateCreateButtonState();
}

function setQuickMode(mode) {
    quickMode = mode;

    // –í–∏–∑—É–∞–ª—å–Ω–æ: –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –¥–µ–ª–∞–µ–º primary
    if (quickMode === "copy") {
        quickBtnCopy.classList.remove("btn-secondary");
        quickBtnCopy.classList.add("btn-primary");
        quickBtnCustom.classList.remove("btn-primary");
        quickBtnCustom.classList.add("btn-secondary");

        // –í—Å—Ç–∞–≤–ª—è–µ–º –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–º—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        taskPromptEl.value = COPY_PROMPT_TEXT;
    } else {
        quickBtnCustom.classList.remove("btn-secondary");
        quickBtnCustom.classList.add("btn-primary");
        quickBtnCopy.classList.remove("btn-primary");
        quickBtnCopy.classList.add("btn-secondary");

        // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
        taskPromptEl.value = DEFAULT_PLACEHOLDER_TEXT;
    }

    updateCreateButtonState();
}

function {{modal_id}}_open() {
    console.log("open modal");
    const modal = document.getElementById('{{modal_id}}');
    modal.classList.add('active');

    const ref_url = document.getElementById('refUrl');
    if (!ref_url.value.trim()) {
        setPreviewNotUsed();
    }

    // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ ‚Äî —Ä–µ–∂–∏–º "–°–≤–æ–π –ø—Ä–æ–º—Ç" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    setQuickMode("custom");
}

function {{modal_id}}_close() {
    const modal = document.getElementById('{{modal_id}}');
    modal.classList.remove('active');
}

function ref_url_event() {
    console.log("stop typing, csfr: " + getCookie("csrftoken"));
    const ref_url = document.getElementById('refUrl');

    const url = ref_url.value.trim();
    if (!url) {
        setPreviewNotUsed();
        return;
    }

    setPreviewLoading();

    if (lastController) lastController.abort();
    lastController = new AbortController();

    fetch("{% url 'reference_screenshot' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({ url }),
        signal: lastController.signal
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.status) {
            setPreviewSuccess(data.img);
        } else {
            setPreviewError(data.error || "{% trans '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞' %}");
        }
    })
    .catch(err => {
        if (err.name !== "AbortError") {
            setPreviewError("{% trans '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º' %}");
        }
    });
}

function start_site_creation() {

    // –î–æ–ø. –∑–∞—â–∏—Ç–∞: –ø—Ä–∏ —Ä–µ–∂–∏–º–µ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" –Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –±–µ–∑ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–µ–≤—å—é
    if (quickMode === "copy" && !screenshotOk) {
        alert("{% trans '–°–Ω–∞—á–∞–ª–∞ –¥–æ–∂–¥–∏—Ç–µ—Å—å —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–≤—å—é —Ä–µ—Ñ–µ—Ä–µ–Ω—Å-—Å–∞–π—Ç–∞' %}");
        return;
    }

    const payload = {
      refUrl: document.getElementById("refUrl").value.trim(),
      taskPrompt: document.getElementById("taskPrompt").value.trim(),
      siteCount: parseInt(document.getElementById("siteCount").value || "1", 10),
    };

  fetch("/create_site_task/", {
      method: "POST",
      headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify(payload),
  })
  .then(r => r.json())
    .then(data => {
        if (data.status) {
            const url = data.redirect_url || "/dashboard/";
            window.location.href = url; // –∏–ª–∏ window.location.assign(url)
        } else {
            alert(data.error || "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á–∏");
        }
    })
  .catch(() => alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"));

}

document.addEventListener('DOMContentLoaded', () => {
    const close_btn_head = document.getElementById('createModalCloseBtn');
    close_btn_head.addEventListener('click', (e) => { if (e.target === close_btn_head) {{modal_id}}_close(); });
    const cancel_btn_botton = document.getElementById("cancelCreateBtn");
    cancel_btn_botton.addEventListener('click', (e) => { if (e.target === cancel_btn_botton) {{modal_id}}_close(); });

    const ref_url = document.getElementById('refUrl');

    ref_url.addEventListener('input', () => {
        const url = ref_url.value.trim();

        if (!url) {
            if (ref_url_typing_timer) clearTimeout(ref_url_typing_timer);
            setPreviewNotUsed();
            return;
        }

        if (ref_url_typing_timer) clearTimeout(ref_url_typing_timer);
        ref_url_typing_timer = setTimeout(ref_url_event, ref_url_delay);
    });

    startCreateBtn.addEventListener("click", () => {
        start_site_creation();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫
    if (quickBtnCopy) {
        quickBtnCopy.addEventListener("click", () => setQuickMode("copy"));
    }
    if (quickBtnCustom) {
        quickBtnCustom.addEventListener("click", () => setQuickMode("custom"));
    }

    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ ‚Äî —Ä–µ–∂–∏–º "–°–≤–æ–π –ø—Ä–æ–º—Ç"
    setQuickMode("custom");
    updateCreateButtonState();
});

</script>
