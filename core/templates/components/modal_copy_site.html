{% load i18n %}
<div class="modal-overlay" id="modal_copy_site" hidden>
  <div class="modal">
    <div class="modal-header">
      <h3>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–π—Ç</h3>
      <button class="modal-close" id="copyModalCloseBtn" aria-label="{% trans '–ó–∞–∫—Ä—ã—Ç—å' %}">‚úï</button>
    </div>
    <div class="modal-body two-columns">
      <div class="modal-left">
        <div class="form-group">
          <label for="copyRefUrl"><strong>{% trans "–£–∫–∞–∂–∏—Ç–µ URL —Å–∞–π—Ç–∞" %}:</strong></label>
          <input type="url" id="copyRefUrl" placeholder="https://example.com" />
          <div class="hint" id="copyRefHint">{% trans "–í–≤–µ–¥–∏—Ç–µ URL" %}</div>
          <div class="hint error" id="copyRefError" style="display:none;"></div>
        </div>
      </div>

      <div class="modal-right">
        <div class="screenshot-box" id="copyScreenshotBox">
          <div id="copyPreviewLoader" style="display:none;">
              <div class="gradient-loader"></div>
            </div>


          <div class="preview-placeholder" id="copyPreviewNotUsed">
            <div class="placeholder-icon">üõà</div>
            <div class="placeholder-text">{% trans "–í–≤–µ–¥–∏—Ç–µ URL" %}</div>
          </div>

          <div class="preview-placeholder error" id="copyPreviewErrorState" style="display:none;">
            <div class="placeholder-icon">‚ö†</div>
            <div class="placeholder-text">{% trans "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏" %}</div>
          </div>

          <div class="screenshot-scroll">
            <img id="copyRefPreview" alt="{% trans '–ü—Ä–µ–≤—å—é —Å–∞–π—Ç–∞' %}" />
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="copyStartBtn" disabled>{% trans '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å' %}</button>
      <button class="btn btn-secondary" id="copyCancelBtn">{% trans '–û—Ç–º–µ–Ω–∞' %}</button>
    </div>
  </div>
</div>

<script>
(() => {
  const modal    = document.getElementById('modal_copy_site');
  const input    = document.getElementById('copyRefUrl');
  const btnOk    = document.getElementById('copyStartBtn');
  const btnClose = document.getElementById('copyModalCloseBtn');
  const btnCancel= document.getElementById('copyCancelBtn');

  const hint  = document.getElementById('copyRefHint');
  const errEl = document.getElementById('copyRefError');

  const loader = document.getElementById('copyPreviewLoader');
  const notUsed= document.getElementById('copyPreviewNotUsed');
  const errBox = document.getElementById('copyPreviewErrorState');
  const img    = document.getElementById('copyRefPreview');

  let typingTimer = null;
  let lastController = null;
  const delay = 1200;
  let screenshotOk = false;

  function show()   { modal.removeAttribute('hidden'); modal.classList.add('active'); }
  function hide()   { modal.classList.remove('active'); modal.setAttribute('hidden',''); resetState(); }
  function resetState() {
    setNotUsed();
    input.value = input.value || '';
    btnOk.disabled = true;
  }

  function setLoading() {
    errEl.style.display = 'none';
    hint.textContent = "{% trans '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é...' %}";
    screenshotOk = false;

    loader.style.display = 'block';
    notUsed.style.display = 'none';
    errBox.style.display = 'none';
    img.style.display = 'none';
    img.src = '';
    btnOk.disabled = true;
  }
  function setNotUsed() {
    errEl.style.display = 'none';
    hint.textContent = "{% trans '–í–≤–µ–¥–∏—Ç–µ URL' %}";
    screenshotOk = false;

    loader.style.display = 'none';
    notUsed.style.display = 'flex';
    errBox.style.display = 'none';
    img.style.display = 'none';
    img.src = '';
    btnOk.disabled = true;
  }
  function setError(message) {
    errEl.textContent = message || "{% trans '–û—à–∏–±–∫–∞' %}";
    errEl.style.display = 'block';
    hint.textContent = "{% trans '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–≤—å—é' %}";
    screenshotOk = false;

    loader.style.display = 'none';
    notUsed.style.display = 'none';
    errBox.style.display = 'flex';
    img.style.display = 'none';
    img.src = '';
    btnOk.disabled = true;
  }
  function setSuccess(url) {
    errEl.style.display = 'none';
    hint.textContent = "";
    screenshotOk = true;

    loader.style.display = 'none';
    notUsed.style.display = 'none';
    errBox.style.display = 'none';
    img.style.display = 'block';
    img.onload = () => {};
    img.src = url;
    btnOk.disabled = false;
  }

  function requestPreview(url) {
    if (lastController) lastController.abort();
    lastController = new AbortController();
    setLoading();

    fetch("{% url 'reference_screenshot' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify({ url }),
      signal: lastController.signal
    })
      .then(r => r.json())
      .then(d => {
        if (d.status) setSuccess(d.img);
        else setError(d.error || "{% trans '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞' %}");
      })
      .catch(e => {
        if (e.name !== 'AbortError') setError("{% trans '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º' %}");
      });
  }

  function onInputChanged() {
    const url = (input.value || '').trim();
    if (!url) { setNotUsed(); return; }
    if (typingTimer) clearTimeout(typingTimer);
    typingTimer = setTimeout(() => requestPreview(url), delay);
  }

  btnOk.addEventListener('click', () => {
    const url = (input.value || '').trim();
    if (!url || !screenshotOk) return;
    btnOk.disabled = true;

    fetch('/create_site_task_copy_by_url/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify({
        refUrl: url,
      })
    })
      .then(r => r.json())
      .then(d => {
        if (d.status) {
          window.location.href = d.redirect_url || '/dashboard/';
        } else {
          alert(d.error || '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á–∏');
          btnOk.disabled = false;
        }
      })
      .catch(() => { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); btnOk.disabled = false; });
  });

  btnClose.addEventListener('click', hide);
  btnCancel.addEventListener('click', hide);
  input.addEventListener('input', onInputChanged);

  window.modal_copy_site_open = function() {
    resetState();
    show();
    const val = (input.value || '').trim();
    if (!val) setNotUsed();
  }
})();
</script>
