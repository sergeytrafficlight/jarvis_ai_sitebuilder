{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Дашборд" %}{% endblock %}
{% block content %}
<h2>{% trans "Дашборд" %}</h2>
<div class="dashboard-top">
    <div class="balance-card">
        <div class="balance-label">{% trans "Текущий баланс" %}</div>
        <a class="balance-value" href="{% url 'billing_history' %}">{{ profile.balance|default:"0.00" }} USD</a>
    </div>
    <div class="topup-action">
        <a class="btn btn-primary" href="{% url 'topup' %}">{% trans "Пополнить" %}</a>
    </div>
    <div class="topup-action">
        <button class="btn btn-primary" id="modal_create_site_open_btn_id">{% trans "Создать сайт" %}</button>
    </div>

</div>

<section class="sites-section">
    <h3>{% trans "Ваши сайты" %}</h3>

    <div class="card" style="margin-bottom:10px;">
        <button class="btn btn-secondary" id="btnSelectAll">{% trans "Выбрать все" %}</button>
        <button class="btn btn-secondary" id="btnUnselectAll" style="margin-left:6px;">{% trans "Снять выделение" %}</button>
        <button class="btn btn-primary" id="btnBulkDelete" style="margin-left:6px;" disabled>{% trans "Удалить выбранные" %}</button>
    </div>

    <div class="card">
        <table class="table">
            <thead>
                <tr>
                    <th></th>
                    <th>{% trans "Название" %}</th>
                    <th>{% trans "Создан" %}</th>
                    <th>{% trans "Статус" %}</th>
                    <th>{% trans "Расход" %}</th>
                    <th>{% trans "Действия" %}</th>
                </tr>
            </thead>
            <tbody>
            {% if page_obj and page_obj.object_list %}
                {% for s in page_obj.object_list %}
                <tr id="site-row-{{ s.id }}">
                    <td>
                        <input type="checkbox" class="site-check" value="{{ s.id }}" />
                    </td>
                    <td>{{ s.name }}</td>
                    <td>{{ s.created_at|date:"d.m.Y H:i" }}</td>
                   <td>
                       <div class="site-status muted" data-site-id="{{ s.id }}">—</div>
                   </td>

                    <td>{{ s.get_balance|default:0|floatformat:6 }}</td>
                    <td>
                        <a class="btn btn-secondary" href="{% url 'site_download_latest' s.id %}">Скачать</a>
                        <a class="btn btn-secondary" href="{% url 'site_detail' s.id %}">{% trans "Открыть" %}</a>
                        <button class="btn btn-secondary btn-delete-one" data-id="{{ s.id }}">{% trans "Удалить" %}</button>
                    </td>

                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5" class="muted">{% trans "Пока нет созданных сайтов." %}</td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

    {% if page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="card" style="display:flex;gap:10px;align-items:center;justify-content:center;">
        {% if page_obj.has_previous %}
        <a class="btn btn-secondary" href="?page={{ page_obj.previous_page_number }}">« {% trans "Назад" %}</a>
        {% endif %}
        <span class="muted">{% trans "Страница" %} {{ page_obj.number }} {% trans "из" %} {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
        <a class="btn btn-secondary" href="?page={{ page_obj.next_page_number }}">{% trans "Вперёд" %} »</a>
        {% endif %}
    </div>
    {% endif %}
</section>


{% include 'components/modal_create_site.html' with modal_id="modal_create_site" %}


<script>
document.addEventListener('DOMContentLoaded', () => {
    // Кнопка открытия модалки создания
    const modal_create_site_open_btn = document.getElementById('modal_create_site_open_btn_id');
    if (modal_create_site_open_btn) {
        modal_create_site_open_btn.addEventListener('click', () => { modal_create_site_open(); });
    }

    // Выбор и массовое удаление
    const btnSelectAll   = document.getElementById('btnSelectAll');
    const btnUnselectAll = document.getElementById('btnUnselectAll');
    const btnBulkDelete  = document.getElementById('btnBulkDelete');

    function getChecks() {
        return Array.from(document.querySelectorAll('.site-check'));
    }
    function getSelectedIds() {
        return getChecks().filter(c => c.checked).map(c => parseInt(c.value, 10));
    }
    function updateBulkState() {
        const cnt = getSelectedIds().length;
        btnBulkDelete.disabled = cnt === 0;
    }

    if (btnSelectAll) {
        btnSelectAll.addEventListener('click', () => {
            getChecks().forEach(c => c.checked = true);
            updateBulkState();
        });
    }
    if (btnUnselectAll) {
        btnUnselectAll.addEventListener('click', () => {
            getChecks().forEach(c => c.checked = false);
            updateBulkState();
        });
    }
    getChecks().forEach(c => c.addEventListener('change', updateBulkState));

    async function bulkArchive(ids) {
        const resp = await fetch("/sites/bulk_archive/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ ids }),
        });
        return resp.json();
    }

    if (btnBulkDelete) {
        btnBulkDelete.addEventListener('click', async () => {
            const ids = getSelectedIds();
            if (!ids.length) return;

            btnBulkDelete.disabled = true;
            try {
                const data = await bulkArchive(ids);
                if (data.status) {
                    // Самый простой: перезагрузим страницу, чтобы корректно обновить пагинацию
                    window.location.reload();
                } else {
                    alert(data.error || "Ошибка удаления");
                }
            } catch(e) {
                alert("Ошибка сети");
            } finally {
                btnBulkDelete.disabled = false;
            }
        });
    }

    // Одиночное удаление
    document.querySelectorAll('.btn-delete-one').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            if (!id) return;
            e.currentTarget.disabled = true;

            try {
                const resp = await fetch(`/sites/${id}/archive/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                    }
                });
                const data = await resp.json();
                if (data.status) {
                    // Удаляем строку из DOM и, если страницу «опустошили», перезагрузим
                    const row = document.getElementById(`site-row-${id}`);
                    if (row) row.remove();
                    // Если таблица теперь пустая — просто обновим страницу (удобно при пагинации)
                    if (!document.querySelector('.site-check')) {
                        window.location.reload();
                    } else {
                        updateBulkState();
                    }
                } else {
                    alert(data.error || "Ошибка удаления");
                }
            } catch (err) {
                alert("Ошибка сети");
            } finally {
                e.currentTarget.disabled = false;
            }
        });
    });


// ----
  const statusCells = Array.from(document.querySelectorAll('.site-status'));

  function renderSiteStatus(el, data) {
      const by = data.by_status || {};
      const awaiting = by.awaiting || 0;
      const processing = by.processing || 0;
      const done = by.done || 0;
      const error = by.error || 0;
      const active = data.active || 0;

      let overall = 'Готов';
      if (active > 0) overall = 'Выполняется';
      else if (error > 0) overall = 'Есть ошибки';

      el.innerHTML = `${overall}: Активных: ${active}; `
        // + `ожидает: ${awaiting}, в работе: ${processing}, готово: ${done}, ошибка: ${error}`;
      el.classList.toggle('muted', false);
    }

  async function fetchAndRenderOne(el) {
      const siteId = el.getAttribute('data-site-id');
      if (!siteId) return;
      try {
          const resp = await fetch(`/api/site/${siteId}/tasks_status/`, {
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          const data = await resp.json();
          if (data && data.status) {
              renderSiteStatus(el, data);
          } else {
              el.textContent = '—';
          }
      } catch (e) {
          // тихо игнорим ошибки сети
      }
  }

  async function pollAllSites() {
      await Promise.all(statusCells.map(fetchAndRenderOne));
  }

  // первый вызов сразу и периодический
  pollAllSites();
  const statusTimer = setInterval(pollAllSites, 3000);
  window.addEventListener('beforeunload', () => clearInterval(statusTimer));

});
</script>


{% endblock %}
