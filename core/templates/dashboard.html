{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "–î–∞—à–±–æ—Ä–¥" %}{% endblock %}
{% block content %}
<h2>–î–∞—à–±–æ—Ä–¥</h2>


<div class="card" style="display:flex; gap:14px; justify-content:flex-start; align-items:center; flex-wrap:wrap;">
  {% if not has_funds %}
    <a class="btn btn-primary btn-lg" href="{% url 'topup' %}" id="dashboardTopupBtn">üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</a>
  {% endif %}

  <button
    class="btn btn-primary btn-lg"
    id="openCopyModalBtn"
    {% if not has_funds %}disabled title="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"{% endif %}
  >
    üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–π—Ç
  </button>

  <button
    class="btn btn-primary btn-lg"
    id="openCreateModalBtn"
    {% if not has_funds %}disabled title="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"{% endif %}
  >
    ‚ú® –°–æ–∑–¥–∞—Ç—å —Å–∞–π—Ç
  </button>
</div>

<section class="sites-section">
    <h3>{% trans "–í–∞—à–∏ —Å–∞–π—Ç—ã" %}</h3>

    <div class="card" style="margin-bottom:10px;">
        <button class="btn btn-secondary" id="btnSelectAll">{% trans "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" %}</button>
        <button class="btn btn-secondary" id="btnUnselectAll" style="margin-left:6px;">{% trans "–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ" %}</button>
        <button class="btn btn-primary" id="btnBulkDelete" style="margin-left:6px;" disabled>{% trans "–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ" %}</button>
    </div>

    <div class="card">
        <table class="table">
            <thead>
                <tr>
                    <th></th>
                    <th>{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ" %}</th>
                    <th>{% trans "–°–æ–∑–¥–∞–Ω" %}</th>
                    <th>{% trans "–°—Ç–∞—Ç—É—Å" %}</th>
                    <th>{% trans "–†–∞—Å—Ö–æ–¥" %}</th>
                    <th>{% trans "–î–µ–π—Å—Ç–≤–∏—è" %}</th>
                </tr>
            </thead>
            <tbody>
            {% if page_obj and page_obj.object_list %}
                {% for s in page_obj.object_list %}
                <tr id="site-row-{{ s.id }}">
                    <td>
                        <input type="checkbox" class="site-check" value="{{ s.id }}" />
                    </td>
                      <td>
                        <span id="site-name-{{ s.id }}">{{ s.name }}</span>
                        <button class="icon-btn btn-edit-sitename" data-id="{{ s.id }}" data-name="{{ s.name|escape }}" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úé</button>
                      </td>

                    <td>{{ s.created_at|date:"d.m.Y H:i" }}</td>
                   <td>
                       <div class="site-status muted" data-site-id="{{ s.id }}">‚Äî</div>
                   </td>

                    <td>{{ s.get_balance|default:0|floatformat:6 }}</td>
                    <td>
                        <a class="btn btn-secondary" href="{% url 'site_download_latest' s.id %}">–°–∫–∞—á–∞—Ç—å</a>
                        <a class="btn btn-secondary" href="{% url 'site_detail' s.id %}">{% trans "–û—Ç–∫—Ä—ã—Ç—å" %}</a>
                        <button class="btn btn-secondary btn-delete-one" data-id="{{ s.id }}">{% trans "–£–¥–∞–ª–∏—Ç—å" %}</button>
                    </td>

                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5" class="muted">{% trans "–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤." %}</td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

    {% if page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="card" style="display:flex;gap:10px;align-items:center;justify-content:center;">
        {% if page_obj.has_previous %}
        <a class="btn btn-secondary" href="?page={{ page_obj.previous_page_number }}">¬´ {% trans "–ù–∞–∑–∞–¥" %}</a>
        {% endif %}
        <span class="muted">{% trans "–°—Ç—Ä–∞–Ω–∏—Ü–∞" %} {{ page_obj.number }} {% trans "–∏–∑" %} {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
        <a class="btn btn-secondary" href="?page={{ page_obj.next_page_number }}">{% trans "–í–ø–µ—Ä—ë–¥" %} ¬ª</a>
        {% endif %}
    </div>
    {% endif %}
</section>


{% include 'components/modal_copy_site.html' %}
{% include 'components/modal_create_site_prompt.html' %}
{% include 'components/modal_edit_site_name.html' %}

<script>
document.addEventListener('DOMContentLoaded', () => {
  const btnCopy  = document.getElementById('openCopyModalBtn');
  const btnCreate = document.getElementById('openCreateModalBtn');

  if (btnCopy)   btnCopy.addEventListener('click', () => { modal_copy_site_open(); });
  if (btnCreate) btnCreate.addEventListener('click', () => { modal_create_site_prompt_open(); });


    // –í—ã–±–æ—Ä –∏ –º–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
    const btnSelectAll   = document.getElementById('btnSelectAll');
    const btnUnselectAll = document.getElementById('btnUnselectAll');
    const btnBulkDelete  = document.getElementById('btnBulkDelete');

    function getChecks() {
        return Array.from(document.querySelectorAll('.site-check'));
    }
    function getSelectedIds() {
        return getChecks().filter(c => c.checked).map(c => parseInt(c.value, 10));
    }
    function updateBulkState() {
        const cnt = getSelectedIds().length;
        btnBulkDelete.disabled = cnt === 0;
    }

    if (btnSelectAll) {
        btnSelectAll.addEventListener('click', () => {
            getChecks().forEach(c => c.checked = true);
            updateBulkState();
        });
    }
    if (btnUnselectAll) {
        btnUnselectAll.addEventListener('click', () => {
            getChecks().forEach(c => c.checked = false);
            updateBulkState();
        });
    }
    getChecks().forEach(c => c.addEventListener('change', updateBulkState));

    async function bulkArchive(ids) {
        const resp = await fetch("/sites/bulk_archive/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ ids }),
        });
        return resp.json();
    }

    if (btnBulkDelete) {
        btnBulkDelete.addEventListener('click', async () => {
            const ids = getSelectedIds();
            if (!ids.length) return;

            btnBulkDelete.disabled = true;
            try {
                const data = await bulkArchive(ids);
                if (data.status) {
                    // –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π: –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                    window.location.reload();
                } else {
                    alert(data.error || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
                }
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            } finally {
                btnBulkDelete.disabled = false;
            }
        });
    }

    // –û–¥–∏–Ω–æ—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
    document.querySelectorAll('.btn-delete-one').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            if (!id) return;
            if (!confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–∞–π—Ç?')) return;
            e.currentTarget.disabled = true;

            try {
                const resp = await fetch(`/sites/${id}/archive/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                    }
                });
                const data = await resp.json();
                if (data.status) {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ DOM –∏, –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É ¬´–æ–ø—É—Å—Ç–æ—à–∏–ª–∏¬ª, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º
                    const row = document.getElementById(`site-row-${id}`);
                    if (row) row.remove();
                    // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Ç–µ–ø–µ—Ä—å –ø—É—Å—Ç–∞—è ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É (—É–¥–æ–±–Ω–æ –ø—Ä–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏)
                    if (!document.querySelector('.site-check')) {
                        window.location.reload();
                    } else {
                        updateBulkState();
                    }
                } else {
                    alert(data.error || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
                }
            } catch (err) {
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            } finally {
                e.currentTarget.disabled = false;
            }
        });
    });


// ----
  const statusCells = Array.from(document.querySelectorAll('.site-status'));

  function renderSiteStatus(el, data) {
      const by = data.by_status || {};
      const awaiting = by.awaiting || 0;
      const processing = by.processing || 0;
      const done = by.done || 0;
      const error = by.error || 0;
      const active = data.active || 0;

      let overall = '–ì–æ—Ç–æ–≤';
      if (active > 0) overall = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è';
      else if (error > 0) overall = '–ï—Å—Ç—å –æ—à–∏–±–∫–∏';

      el.textContent = `${overall}: –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${active}`;
        // + `–æ–∂–∏–¥–∞–µ—Ç: ${awaiting}, –≤ —Ä–∞–±–æ—Ç–µ: ${processing}, –≥–æ—Ç–æ–≤–æ: ${done}, –æ—à–∏–±–∫–∞: ${error}`;
      el.classList.toggle('muted', false);
    }

  async function fetchAndRenderOne(el) {
      const siteId = el.getAttribute('data-site-id');
      if (!siteId) return;
      try {
          const resp = await fetch(`/api/site/${siteId}/tasks_status/`, {
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          const data = await resp.json();
          if (data && data.status) {
              renderSiteStatus(el, data);
          } else {
              el.textContent = '‚Äî';
          }
      } catch (e) {
          // —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏–º –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏
      }
  }

  async function pollAllSites() {
      await Promise.all(statusCells.map(fetchAndRenderOne));
  }

  // –ø–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ —Å—Ä–∞–∑—É –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π
  pollAllSites();
  const statusTimer = setInterval(pollAllSites, 3000);
  window.addEventListener('beforeunload', () => clearInterval(statusTimer));

});
</script>

 <script>
  (function() {
    const modal = document.getElementById('modal_edit_site_name');
    const input = document.getElementById('editSiteNameInput');
    const btnSave = document.getElementById('editSiteNameSave');
    const err = document.getElementById('editSiteNameError');
    let currentSiteId = null;

    function openModal(siteId, currentName) {
      currentSiteId = siteId;
      err.style.display = 'none';
      input.value = currentName || '';
      modal.removeAttribute('hidden');
      modal.classList.add('active');
      setTimeout(()=>input.focus(), 10);
    }
    function closeModal() {
      modal.classList.remove('active');
      modal.setAttribute('hidden','');
      currentSiteId = null;
    }
    document.body.addEventListener('click', (e) => {
      const sel = e.target?.getAttribute('data-close');
      if (sel) {
        const m = document.querySelector(sel);
        if (m) m.classList.remove('active'), m.setAttribute('hidden','');
      }
      if (e.target && e.target.classList.contains('btn-edit-sitename')) {
        const id = parseInt(e.target.getAttribute('data-id'), 10);
        const name = e.target.getAttribute('data-name') || '';
        openModal(id, name);
      }
    });

    async function renameSite(id, name) {
      const resp = await fetch(`/api/site/${id}/rename/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ name })
      });
      return resp.json();
    }

    if (btnSave) {
      btnSave.addEventListener('click', async () => {
        const name = (input.value || '').trim();
        if (!currentSiteId) return;
        if (!name) {
          err.textContent = '–ò–º—è –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
          err.style.display = 'block';
          return;
        }
        if (name.length > 120) {
          err.textContent = '–ò–º—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å. 120)';
          err.style.display = 'block';
          return;
        }
        btnSave.disabled = true;
        try {
          const r = await renameSite(currentSiteId, name);
          if (!r.status) {
            err.textContent = r.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
            err.style.display = 'block';
            return;
          }
          const span = document.getElementById(`site-name-${currentSiteId}`);
          if (span) span.textContent = r.name || name;

          // –æ–±–Ω–æ–≤–∏–º data-name —É –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ —Ä—è–¥–æ–º –≤ DOM
          const rowBtn = document.querySelector(`.btn-edit-sitename[data-id="${currentSiteId}"]`);
          if (rowBtn) rowBtn.setAttribute('data-name', r.name || name);

          closeModal();
        } catch(e) {
          err.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
          err.style.display = 'block';
        } finally {
          btnSave.disabled = false;
        }
      });
    }

    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ (Enter/Esc)
    function modalIsOpen() { return !modal.hasAttribute('hidden'); }
    function onKeyDown(e) {
      if (!modalIsOpen()) return;
      if (e.key === 'Escape') {
        e.preventDefault();
        closeModal();
      } else if (e.key === 'Enter') {
        if (document.activeElement && document.activeElement.tagName === 'TEXTAREA') return;
        e.preventDefault();
        btnSave.click();
      }
    }
    document.addEventListener('keydown', onKeyDown);

  })();
  </script>



{% endblock %}
