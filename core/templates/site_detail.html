
{% extends 'base.html' %}
{% load i18n %}
{% block title %}{{ site.name }}{% endblock %}

{% block content %}
<style>
  .layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 16px;
    align-items: start;
  }
  .sidebar {
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 14px;
    padding: 12px;
    position: sticky;
    top: 74px; /* –Ω–∏–∂–µ —à–∞–ø–∫–∏ */
    max-height: calc(100vh - 100px);
    overflow: auto;
  }
  .side-item {
    display: block;
    padding: 8px 10px;
    border-radius: 10px;
    color: var(--text);
    border: 1px solid transparent;
    margin-bottom: 6px;
    text-decoration: none;
  }
  .side-item:hover {
    text-decoration: none;
    background: rgba(255,255,255,0.04);
    border-color: rgba(255,255,255,0.08);
  }
  .side-item.active {
    background: rgba(79,70,229,0.12);
    border-color: rgba(79,70,229,0.45);
    color: #c7d2fe;
  }
  .main-col .card + .card { margin-top: 12px; }

  /* –ü—Ä–µ–≤—å—é –≤—ã–Ω–µ—Å–µ–Ω–æ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä) –ø–æ–¥ —Å–µ—Ç–∫–æ–π */
  .card-preview { margin-top: 12px; }
  .iframe-wrap {
    height: 80vh;
    min-height: 520px;
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 14px;
    overflow: hidden;
    background: #0b1220;
  }
  .iframe-wrap iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
  }

  .muted { color: var(--muted); }
  .textarea {
    width: 100%;
    min-height: 140px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    padding: 10px 12px;
    color: var(--text);
    resize: vertical;
  }
</style>

<div class="site-title-row" style="display:flex; align-items:center; gap:12px;">
  <h2 id="site_name" style="margin:0; flex:1 1 auto;">{{ site.name }}</h2>
  <div id="site_spend" class="muted" style="margin-left:auto; white-space:nowrap;">
    –†–∞—Å—Ö–æ–¥: {{ site.get_balance|default:0|floatformat:6 }} USD
  </div>
</div>



<!-- –í–µ—Ä—Ö–Ω—è—è –¥–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω–∞—è —á–∞—Å—Ç—å: —Å–ª–µ–≤–∞ –¥–µ—Ä–µ–≤–æ, —Å–ø—Ä–∞–≤–∞ —Å—Ç–∞—Ç—É—Å + –ø—Ä–æ–º—Ç -->
<div class="layout">
  <aside class="sidebar">
    <div class="muted" style="margin-bottom:8px;">–í–µ—Ä—Å–∏–∏ (SubSiteProject)</div>
    {% if flat_tree %}
        {% for item in flat_tree %}
          {% with sub=item.node %}
            <a
              class="side-item {% if selected_sub and selected_sub.id == sub.id %}active{% endif %}"
              href="{% url 'site_detail' site.id %}?sub={{ sub.id }}"
              style="margin-left: {{ item.indent }}px;"
              data-sub-id="{{ sub.id }}"
              id="sub-link-{{ sub.id }}"
            >
              #{{ sub.dir }} <span class="muted js-sub-status" id="sub-status-{{ sub.id }}">({{ sub.get_status }})</span>
            </a>

            {% if selected_sub and selected_sub.id == sub.id %}
              <div class="subtasks" id="current-sub-tasks" style="margin-left: {{ item.indent }}px;">
                <div class="subtasks-title">–ó–∞–¥–∞—á–∏ —Å–∞–±—Å–∞–π—Ç–∞</div>
                <ul class="tasks-list" id="current-sub-tasks-list">
                  <li class="muted" id="current-sub-tasks-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
                </ul>
              </div>
            {% endif %}
          {% endwith %}
        {% endfor %}

    {% else %}
      <div class="muted">–ù–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π</div>
    {% endif %}
  </aside>

  <div class="main-col">
    <div class="card">
      <strong>–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á</strong>
      <div id="tasksStatus" class="muted" style="margin-top:6px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>


    <div class="card">
      <strong>–ü—Ä–æ–º—Ç –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –ª–µ–Ω–¥–∏–Ω–≥–∞</strong>
      <div style="margin-top:8px;">
        <textarea id="correctionPrompt" class="textarea" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å..."></textarea>
      </div>
      <div style="margin-top:10px; text-align:right;">
        <button class="btn btn-primary" id="sendCorrectionBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ù–∏–∂–µ ‚Äî –ø—Ä–µ–≤—å—é –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) -->
  <div class="card card-preview">
    <div class="card-preview-header" style="display:flex; align-items:center; gap:10px;">
      <strong>–ü—Ä–µ–≤—å—é –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏</strong>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <button class="btn btn-secondary" id="editToggleBtn">–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</button>
        {% if selected_sub %}
          <a class="btn btn-secondary" href="{% url 'subsite_download' selected_sub.id %}">–°–∫–∞—á–∞—Ç—å</a>
        {% endif %}
        {% if iframe_src %}
          <a class="btn btn-primary" id="openSiteBtn" href="{{ iframe_src }}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å</a>
        {% endif %}
      </div>
    </div>


    <div class="iframe-wrap" style="margin-top:10px;">
      {% if iframe_src %}
        <iframe id="previewFrame" src="{{ iframe_src }}"></iframe>
      {% else %}
        <div class="muted" style="padding:12px;">index.html –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–∞–π—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –≤–µ—Ä—Å–∏—é.</div>
      {% endif %}
    </div>
  </div>


{% include 'components/modal_iframe_img_edit.html'%}
{% include 'components/modal_iframe_text_edit.html'%}

<script>
(function() {
  const selectedSubId = {{ selected_sub.id|default:"null" }};
  const statusEl = document.getElementById('tasksStatus');
  const promptEl = document.getElementById('correctionPrompt');
  const sendBtn = document.getElementById('sendCorrectionBtn');
  const previewFrame = document.getElementById('previewFrame');
  const site_name = document.getElementById('site_name');
  let lastActiveCount = null;

  async function poll() {
    if (!selectedSubId) return;
    try {
      const resp = await fetch(`/api/subsite/${selectedSubId}/tasks_status/`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const data = await resp.json();
      if (!data.status) throw new Error(data.error || '–û—à–∏–±–∫–∞');


      site_name.innerHTML = data.site_name;

      const active = data.active || 0;
      const total = data.total || 0;

      if (statusEl) {
        statusEl.textContent = `–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á: ${active} (–≤—Å–µ–≥–æ: ${total})`;
      }

      if (lastActiveCount !== null && lastActiveCount !== active && previewFrame) {
          try {
            const u = new URL(previewFrame.src, window.location.origin);
            u.searchParams.set('_ts', Date.now()); // –∞–Ω—Ç–∏-–∫—ç—à
            previewFrame.src = u.toString();
          } catch (e) {
            // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
            previewFrame.src = previewFrame.src;
          }
      }

      lastActiveCount = active;
      const locked = active > 0;
      if (promptEl) {
        promptEl.disabled = locked;
        promptEl.placeholder = locked
          ? '–ò–¥—ë—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á ‚Äî –ø–æ–¥–æ–∂–¥–∏—Ç–µ...'
          : '–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å...';
      }
      if (sendBtn) {
        sendBtn.disabled = locked;
      }


    } catch (e) {
      if (statusEl) statusEl.textContent = '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞';
    }
  }

  poll();
  const timer = setInterval(poll, 3000);
  window.addEventListener('beforeunload', () => clearInterval(timer));
})();
</script>

<script>
(function() {
  const previewFrame = document.getElementById('previewFrame');
  const editToggleBtn = document.getElementById('editToggleBtn');

  const modalText = document.getElementById('modal_edit_text');
  const textMeta = document.getElementById('textMeta');
  const textEditContent = document.getElementById('textEditContent');
  const textEditSaveBtn = document.getElementById('textEditSaveBtn');

  const modalImg = document.getElementById('modal_edit_image');
  const imgMeta = document.getElementById('imgMeta');
  const imgPreview = document.getElementById('imgPreview');

  const imgSize = document.getElementById('imgSize');
  const imgUploadFile = document.getElementById('imgUploadFile');
  const imgUploadBtn = document.getElementById('imgUploadBtn');
  const imgUrlInput = document.getElementById('imgUrlInput');
  const imgUrlBtn = document.getElementById('imgUrlBtn');
  let currentImageRelPath = '';



  // –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω—É–∂–Ω—ã, —á—Ç–æ–±—ã –≤—ã—á–∏—Å–ª–∏—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤–Ω—É—Ç—Ä–∏ —Å–∞–±—Å–∞–π—Ç–∞
  const userId = {{ request.user.id }};
  const siteId = {{ site.id }};
  const subId = {{ selected_sub.id|default:"null" }};
  const subDir = "{{ selected_sub.dir|default:'' }}";

  const state = {
    editMode: false,
    currentTextEl: null,
    cleanupFns: [],
  };

  function openModal(el) {
    el.removeAttribute('hidden');
    el.classList.add('active');
  }
    function closeModal(el) {
      el.classList.remove('active');
      el.setAttribute('hidden', '');
      if (el && el.id === 'modal_edit_image') {
        stopImgAiPolling();
      }
    }

  document.body.addEventListener('click', (e) => {
    const closeSel = e.target?.getAttribute('data-close');
    if (closeSel) {
      const m = document.querySelector(closeSel);
      if (m) closeModal(m);
    }
  });

  function injectEditStyle(doc) {
    if (doc.getElementById('__ai-edit-style')) return;
    const style = doc.createElement('style');
    style.id = '__ai-edit-style';
    style.textContent = `
        .__ai-editable { outline: 2px dashed #4f46e5 !important; outline-offset: 2px; cursor: pointer; }
        .__ai-editable:hover { outline-color: #22d3ee !important; background: rgba(79,70,229,0.06) !important; }
        .__ai-editable-img { outline: 2px dashed #f97316 !important; outline-offset: 2px; cursor: pointer; }
        .__ai-editable-img:hover { outline-color: #fb923c !important; background: rgba(249,115,22,0.06) !important; }

    `;
    doc.head.appendChild(style);
  }

     function isVisible(el) {
       const style = el.ownerDocument.defaultView.getComputedStyle(el);
       if (!style || style.display === 'none' || style.visibility === 'hidden') return false;
       if (style.position === 'fixed') return true;
       return el.offsetParent !== null;
     }


  // –†–∞–∑–º–µ—á–∞–µ–º —Ç–æ–ª—å–∫–æ –ª–∏—Å—Ç–æ–≤—ã–µ —É–∑–ª—ã –±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤
  function markEditableElements(doc) {
    const selectorsText = ['p','h1','h2','h3','h4','h5','h6','span','a','li','button','label','small','strong','em','div'];
    const textNodes = Array.from(doc.querySelectorAll(selectorsText.join(',')))
      .filter(el => el && isVisible(el) && el.children.length === 0 && (el.textContent || '').trim().length > 0);

    textNodes.forEach(el => {
      el.classList.add('__ai-editable');
    });
  }

    /*
  function unmarkEditable(doc) {
    const list = doc.querySelectorAll('.__ai-editable');
    list.forEach(el => {
      el.classList.remove('__ai-editable');
    });
  }
  */

  function markEditableImages(doc) {
    const imgs = Array.from(doc.querySelectorAll('img'))
      .filter(el => el && isVisible(el));
    imgs.forEach(el => el.classList.add('__ai-editable-img'));
  }

  function unmarkEditable(doc) {
    const list = doc.querySelectorAll('.__ai-editable, .__ai-editable-img');
    list.forEach(el => el.classList.remove('__ai-editable', '__ai-editable-img'));
  }


  function cssPathFor(el, doc) {
    if (el.id) return `#${CSS.escape(el.id)}`;
    const parts = [];
    while (el && el.nodeType === 1 && el !== doc.body && el !== doc.documentElement) {
      let selector = el.nodeName.toLowerCase();
      // nth-of-type
      let nth = 1, sib = el;
      while ((sib = sib.previousElementSibling)) {
        if (sib.nodeName === el.nodeName) nth++;
      }
      selector += `:nth-of-type(${nth})`;
      parts.unshift(selector);
      el = el.parentElement;
    }
    return parts.join(' > ');
  }

  function bindIframeHandlers(doc) {
    const onClick = (e) => {
      if (!state.editMode) return;

        const img = e.target.closest('img.__ai-editable-img');
          if (img) {
            e.preventDefault();
            e.stopPropagation();
            state.currentImgEl = img;
            openImgModal(img, doc);
            return;
          }

      const link = e.target.closest('a,button,[role="button"]');
      if (link) e.preventDefault();

      const target = e.target.closest('.__ai-editable');
      if (!target) return;

      e.preventDefault();
      e.stopPropagation();

      state.currentTextEl = target;
      openTextModal(target, doc);
    };
    doc.addEventListener('click', onClick, true);

    const onSubmit = (e) => { if (state.editMode) e.preventDefault(); };
    doc.addEventListener('submit', onSubmit, true);

    state.cleanupFns.push(() => {
      try { doc.removeEventListener('click', onClick, true); } catch(_){}
      try { doc.removeEventListener('submit', onSubmit, true); } catch(_){}
    });
  }


  function withBust(u) {
    try {
      const nu = new URL(u, window.location.origin);
      nu.searchParams.set('_ts', Date.now());
      return nu.toString();
    } catch (_) {
      return u + (u.includes('?') ? '&' : '?') + '_ts=' + Date.now();
    }
  }


    function openImgModal(imgEl, doc) {
        // –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ (—Å —É—á—ë—Ç–æ–º base URL –¥–æ–∫—É–º–µ–Ω—Ç–∞ iframe)
        let src = imgEl.getAttribute('src') || '';
        let absUrl;
        try {
          absUrl = new URL(src, doc.location.href);
        } catch (_) {
          absUrl = null;
        }
        // –≤—ã—á–∏—Å–ª–∏–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –≤–Ω—É—Ç—Ä–∏ —Å–∞–±—Å–∞–π—Ç–∞ (–µ—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç—Å—è)
        const basePrefix = `/users/${userId}/sites/${siteId}/${subDir}/`;
        let relPath = '';
        if (absUrl && absUrl.pathname.startsWith(basePrefix)) {
          relPath = absUrl.pathname.slice(basePrefix.length);
        } else {
          relPath = src;
        }

        currentImageRelPath = relPath; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
        imgMeta.textContent = `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${relPath || src}`;

        if (imgAiNextPrompt) imgAiNextPrompt.value = '';
        if (imgAiSendBtn) imgAiSendBtn.disabled = true;
        startImgAiPolling();

        imgPreview.onload = () => {
          try {
            const w = imgPreview.naturalWidth || 0;
            const h = imgPreview.naturalHeight || 0;
            imgSize.textContent = `–†–∞–∑–º–µ—Ä—ã: ${w} √ó ${h}`;
          } catch(_) {
            imgSize.textContent = '–†–∞–∑–º–µ—Ä—ã: ‚Äî √ó ‚Äî';
          }
        };
        imgPreview.src = absUrl ? absUrl.toString() : src;

        openModal(modalImg);
      }


  function openTextModal(el, doc) {
    textMeta.textContent = `–≠–ª–µ–º–µ–Ω—Ç: <${el.tagName.toLowerCase()}>`;
    textEditContent.value = el.textContent.trim();
    openModal(modalText);
  }

  function setEditMode(on) {
    state.editMode = !!on;
    if (editToggleBtn) {
      editToggleBtn.textContent = on ? '–í—ã–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è' : '–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
    }
    const doc = previewFrame?.contentDocument || previewFrame?.contentWindow?.document;
    if (!doc) return;

    if (on) {
      injectEditStyle(doc);
      markEditableElements(doc);
      markEditableImages(doc);
      bindIframeHandlers(doc);
    } else {
      state.cleanupFns.forEach(fn => { try { fn(); } catch(_){} });
      state.cleanupFns = [];
      unmarkEditable(doc);
      state.currentTextEl = null;
    }
  }

  function currentRelativePath() {
    const doc = previewFrame?.contentWindow;
    if (!doc) return 'index.html';
    let p = (doc.location && doc.location.pathname) || '';
    // –æ–∂–∏–¥–∞–µ–º /users/<uid>/sites/<site_id>/<subdir>/...
    const basePrefix = `/users/${userId}/sites/${siteId}/${subDir}/`;
    if (p.startsWith(basePrefix)) {
      p = p.slice(basePrefix.length);
    }
    if (!p || p.endsWith('/')) p = (p || '') + 'index.html';
    return p;
  }

  async function saveTextToBackend(selector, text) {
    const rel = currentRelativePath();
    const url = `/api/subsite/${subId}/update_text/`;
    const payload = { file: rel, selector, text };

    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify(payload),
    });
    return resp.json();
  }

  if (textEditSaveBtn) {
    textEditSaveBtn.addEventListener('click', async () => {
      const el = state.currentTextEl;
      const doc = previewFrame?.contentDocument || previewFrame?.contentWindow?.document;
      if (!el || !doc || subId === null) { closeModal(modalText); return; }

      const newText = textEditContent.value;

      // –í—ã—á–∏—Å–ª–∏—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä
      const selector = cssPathFor(el, doc);

      // –õ–æ–∫–∞–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ UX
      el.textContent = newText;

      try {
        const res = await saveTextToBackend(selector, newText);
        if (!res.status) {
          alert(res.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          return;
        }
        // –û–±–Ω–æ–≤–∏–º iframe –ø—Ä–æ—Ç–∏–≤ –∫—ç—à–∞
        try {
          const u = new URL(previewFrame.src, window.location.origin);
          u.searchParams.set('_ts', Date.now());
          previewFrame.src = u.toString();
        } catch (e) {
          previewFrame.src = previewFrame.src;
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
      } finally {
        closeModal(modalText);
      }
    });
  }

  if (editToggleBtn) {
    editToggleBtn.addEventListener('click', () => setEditMode(!state.editMode));
  }
  if (previewFrame) {
    previewFrame.addEventListener('load', () => {
      if (state.editMode) setEditMode(true);
    });
  }

 if (imgUploadBtn) {
    imgUploadBtn.addEventListener('click', async () => {
      if (!subId || !currentImageRelPath) return;
      const file = imgUploadFile?.files?.[0];
      if (!file) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'); return; }

      const fd = new FormData();
      fd.append('file', file);
      fd.append('rel_path', currentImageRelPath);

      try {
        const resp = await fetch(`/api/subsite/${subId}/replace_image/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') },
          body: fd
        });
        const data = await resp.json();
        if (!data.status) { alert(data.error || '–û—à–∏–±–∫–∞ –∑–∞–º–µ–Ω—ã'); return; }

        // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é –≤ –º–æ–¥–∞–ª–∫–µ
        imgPreview.src = withBust(data.file_url);

        // –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ iframe, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä—è–º–æ–π —ç–ª–µ–º–µ–Ω—Ç
        if (state.currentImgEl) {
          try {
            const u = new URL(state.currentImgEl.src, (previewFrame?.contentWindow?.location?.href) || window.location.origin);
            u.searchParams.set('_ts', Date.now());
            state.currentImgEl.src = u.toString();
          } catch(_) {
            state.currentImgEl.src = withBust(state.currentImgEl.src);
          }
        } else {
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å iframe –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
          try {
            const u = new URL(previewFrame.src, window.location.origin);
            u.searchParams.set('_ts', Date.now());
            previewFrame.src = u.toString();
          } catch(_) {
            previewFrame.src = previewFrame.src;
          }
        }

      } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
      }
    });
  }

if (imgUrlBtn) {
    imgUrlBtn.addEventListener('click', async () => {
      if (!subId || !currentImageRelPath) return;
      const url = (imgUrlInput?.value || '').trim();
      if (!url) { alert('–£–∫–∞–∂–∏—Ç–µ URL'); return; }

      try {
        const resp = await fetch(`/api/subsite/${subId}/replace_image_by_url/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ rel_path: currentImageRelPath, url })
        });
        const data = await resp.json();
        if (!data.status) { alert(data.error || '–û—à–∏–±–∫–∞ –∑–∞–º–µ–Ω—ã –ø–æ URL'); return; }

        // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é –≤ –º–æ–¥–∞–ª–∫–µ
        imgPreview.src = withBust(data.file_url);

        // –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ iframe
        if (state.currentImgEl) {
          try {
            const u = new URL(state.currentImgEl.src, (previewFrame?.contentWindow?.location?.href) || window.location.origin);
            u.searchParams.set('_ts', Date.now());
            state.currentImgEl.src = u.toString();
          } catch(_) {
            state.currentImgEl.src = withBust(state.currentImgEl.src);
          }
        } else {
          try {
            const u = new URL(previewFrame.src, window.location.origin);
            u.searchParams.set('_ts', Date.now());
            previewFrame.src = u.toString();
          } catch(_) {
            previewFrame.src = previewFrame.src;
          }
        }

      } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–º–µ–Ω–µ –ø–æ URL');
      }
    });
  }


//---------------

    const imgAiNextPrompt = document.getElementById('imgAiNextPrompt');
    const imgAiSendBtn = document.getElementById('imgAiSendBtn');
    const imgAiHistory = document.getElementById('imgAiHistory');
    let imgAiPollTimer = null;

    function stopImgAiPolling() {
      if (imgAiPollTimer) {
        clearInterval(imgAiPollTimer);
        imgAiPollTimer = null;
      }
    }

    function renderImgAiHistory(items) {
      if (!imgAiHistory) return;
      if (!items || !items.length) {
        imgAiHistory.innerHTML = '<div class="muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        return;
      }
      const html = items.map(it => {
        const dt = new Date(it.created_at);
        const d = isNaN(dt.getTime()) ? it.created_at : dt.toLocaleString();
        const c = it.comment ? `<div class="muted" style="margin-top:4px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${escapeHtml(it.comment)}</div>` : '';
        return `
          <div style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.06);">
            <div style="font-size:12px; color:#94a3b8;">${d}</div>
            <div style="margin-top:4px;">${escapeHtml(it.prompt)}</div>
            ${c}
            <div style="margin-top:6px; font-size:12px; color:#cbd5e1;">–°—Ç–∞—Ç—É—Å: ${escapeHtml(it.status)}</div>
          </div>
        `;
      }).join('');
      imgAiHistory.innerHTML = html;
    }

    // –ø—Ä–æ—Å—Ç–∞—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∫–∞
    function escapeHtml(s) {
      return String(s || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    async function fetchImgAiHistory() {
      if (!subId || !currentImageRelPath) return;
      try {
        const convResp = await fetch(`/api/subsite/${subId}/image_ai/conversations/?rel_path=${encodeURIComponent(currentImageRelPath)}`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const tasksResp = await fetchTasksStatus();

        const convData = await convResp.json();
        if (!convData.status) throw new Error(convData.error || '–û—à–∏–±–∫–∞');

        renderImgAiHistory(convData.items || []);

        const tasksActive = (tasksResp && tasksResp.active) ? tasksResp.active > 0 : false;

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –∏ –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ MyTask
        if (imgAiNextPrompt) {
          imgAiNextPrompt.disabled = tasksActive;
          imgAiNextPrompt.placeholder = tasksActive
            ? '–û–∂–∏–¥–∞–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á'
            : '–û–ø–∏—à–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –∫ –ò–ò...';
        }

        // –ö–Ω–æ–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö MyTask –∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö AI-–∫–æ–Ω–≤–µ—Ä—Å–∏–π
        const canSend = !tasksActive && !convData.has_active && !!(imgAiNextPrompt?.value || '').trim();
        if (imgAiSendBtn) imgAiSendBtn.disabled = !canSend;

      } catch(e) {
        // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å muted —Å—Ç–∞—Ç—É—Å
      }
    }


    function startImgAiPolling() {
      stopImgAiPolling();
      fetchImgAiHistory();
      imgAiPollTimer = setInterval(fetchImgAiHistory, 3000);
    }

    // –æ–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
    if (imgAiNextPrompt) {
      imgAiNextPrompt.addEventListener('input', () => {
        // –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º fetch; –Ω–æ –º–æ–∂–Ω–æ –∏ –ª–æ–∫–∞–ª—å–Ω–æ
        // –≤–∫–ª—é—á–∏–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –≤–≤–µ–¥–µ–Ω–æ; –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç fetchImgAiHistory
        const hasText = !!(imgAiNextPrompt.value || '').trim();
        if (imgAiSendBtn) imgAiSendBtn.disabled = !hasText;
      });
    }

    // –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ AI
    if (imgAiSendBtn) {
      imgAiSendBtn.addEventListener('click', async () => {
        if (!subId || !currentImageRelPath) return;
        const prompt = (imgAiNextPrompt?.value || '').trim();
        if (!prompt) return;

        imgAiSendBtn.disabled = true;
        try {
          const resp = await fetch(`/api/subsite/${subId}/image_ai/create/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
              rel_path: currentImageRelPath,
              prompt: prompt,
              // comment: '', // –µ—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –ø–æ–∑–∂–µ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
            }),
          });
          const data = await resp.json();
          if (!data.status) {
            alert(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å');
            return;
          }
          // –æ—á–∏—Å—Ç–∏–º –ø–æ–ª–µ, –∏—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ–ª–ª–µ—Ä–æ–º
          if (imgAiNextPrompt) imgAiNextPrompt.value = '';
          // –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–∏–º
          fetchImgAiHistory();
        } catch(e) {
          alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        }
      });
    }

//--------
    async function fetchTasksStatus() {
      if (!subId) return {status: true, active: 0, total: 0};
      const resp = await fetch(`/api/subsite/${subId}/tasks_status/`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      return resp.json();
    }


})();
</script>

<script>
(function() {
  const subLinks = Array.from(document.querySelectorAll('.side-item[data-sub-id]'));
  async function pollSubStatuses() {
    await Promise.all(subLinks.map(async (link) => {
      const id = link.dataset.subId;
      try {
        const resp = await fetch(`/api/subsite/${id}/tasks_status/`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await resp.json();
        if (!data.status) return;

        const span = document.getElementById(`sub-status-${id}`);
        if (!span) return;

        const by = data.by_status || {};
        const active = data.active || 0;
        const hasError = by.error || 0;

        // –¢–æ –∂–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, —á—Ç–æ –∏ get_status: –µ—Å–ª–∏ –µ—Å—Ç—å AWAITING/PROCESSING ‚Äî processing, –∏–Ω–∞—á–µ done (–∏–ª–∏ error –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏)
        let text = active > 0 ? 'processing' : 'done';
        if (active === 0 && hasError > 0) text = 'error';

        span.textContent = `(${text})`;
      } catch (e) {
        // —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
      }
    }));
  }
  pollSubStatuses();
  const timer = setInterval(pollSubStatuses, 3000);
  window.addEventListener('beforeunload', () => clearInterval(timer));
})();
</script>

<script>
    //tasks list
(function() {
  const selectedSubId = {{ selected_sub.id|default:"null" }};
  const tasksWrap = document.getElementById('current-sub-tasks');
  const tasksList = document.getElementById('current-sub-tasks-list');
  const tasksEmpty = document.getElementById('current-sub-tasks-empty');

  function badgeClass(st) {
    if (st === 'processing') return 'processing';
    if (st === 'error') return 'error';
    return 'awaiting';
  }

  function openTaskEditModal(task) {
    const modal = document.getElementById('modal_task_edit');
    const meta = document.getElementById('taskEditMeta');
    const body = document.getElementById('taskEditBody');
    if (meta) meta.textContent = `#${task.id} ‚Ä¢ ${task.type_label} ‚Ä¢ ${task.status_label}`;
    if (body) {
      body.textContent = JSON.stringify(task, null, 2);
    }
    modal.classList.add('active');
    modal.removeAttribute('hidden');
  }

  async function apiPost(url, payload) {
    const opts = {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest',
      },
    };
    if (payload) {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(payload);
    }
    const r = await fetch(url, opts);
    return r.json();
  }

  function renderTasks(items) {
      if (!tasksList) return;
      tasksList.innerHTML = '';
      if (!items || !items.length) {
        tasksList.innerHTML = '<li class="muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–ª–∏ –æ—à–∏–±–æ—á–Ω—ã—Ö –∑–∞–¥–∞—á</li>';
        return;
      }
      for (const t of items) {
        const li = document.createElement('li');
        li.className = 'task-item';

        // –ë–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞
        const badge = document.createElement('span');
        badge.className = 'task-badge ' + badgeClass(t.status);
        badge.textContent = t.status_label;

        // –ë–µ–π–¥–∂ —Ç–∏–ø–∞ —Ç–∞—Å–∫–∞
        const typeChip = document.createElement('span');
        typeChip.className = 'task-type-badge';
        typeChip.textContent = t.type_label || t.type;

        // –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å
        const main = document.createElement('div');
        main.className = 'task-main';

        const title = document.createElement('div');
        title.className = 'task-title';
        // –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ—Ä–æ—á–µ: –∏–º—è –ø–æ—Å–ª–µ —Ç–∏–ø–∞ –ø–µ—Ä–µ–Ω–æ—Å–∏–º —Å—é–¥–∞ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏
        title.textContent = t.name ? `‚Äî ${t.name}` : '';

        main.appendChild(title);

        // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        const actions = document.createElement('div');
        actions.className = 'task-actions';

        const btnEdit = document.createElement('button');
        btnEdit.className = 'icon-btn';
        btnEdit.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        btnEdit.textContent = '‚úé';
        btnEdit.addEventListener('click', () => openTaskEditModal(t));

        const btnRestart = document.createElement('button');
        btnRestart.className = 'icon-btn';
        btnRestart.title = '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å';
        btnRestart.textContent = '‚Üª';
        btnRestart.addEventListener('click', async () => {
          btnRestart.disabled = true;
          try {
            await apiPost(`/api/task/${t.id}/restart/`);
            await loadTasks();
          } catch(e) {} finally { btnRestart.disabled = false; }
        });

        const btnDelete = document.createElement('button');
        btnDelete.className = 'icon-btn';
        btnDelete.title = '–£–¥–∞–ª–∏—Ç—å';
        btnDelete.textContent = 'üóë';
        btnDelete.addEventListener('click', async () => {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
          btnDelete.disabled = true;
          try {
            await apiPost(`/api/task/${t.id}/delete/`);
            await loadTasks();
          } catch(e) {} finally { btnDelete.disabled = false; }
        });

        actions.appendChild(btnEdit);
        actions.appendChild(btnRestart);
        actions.appendChild(btnDelete);

        // –°–æ–±–∏—Ä–∞–µ–º
        li.appendChild(badge);
        li.appendChild(typeChip);
        li.appendChild(main);
        li.appendChild(actions);

        // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å –æ—à–∏–±–∫–æ–π (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏)
        if (t.status === 'error' && (t.message || '').trim().length) {
          li.classList.add('has-error');

          // –í—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ö–∏–Ω—Ç
          const tip = document.createElement('div');
          tip.className = 'task-error-tip';
          tip.textContent = t.message;
          li.appendChild(tip);

          // –§–æ–ª–±—ç–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö ‚Äî —Å–∏—Å—Ç–µ–º–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞
          li.setAttribute('title', t.message);
        }

        tasksList.appendChild(li);
      }
    }


  async function loadTasks() {
    if (!selectedSubId || !tasksWrap) return;
    try {
      const r = await fetch(`/api/subsite/${selectedSubId}/tasks_list/`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const data = await r.json();
      if (data.status) {
        renderTasks(data.items || []);
      } else {
        tasksList.innerHTML = '<li class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>';
      }
    } catch(e) {
      tasksList.innerHTML = '<li class="muted">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</li>';
    }
  }

  // –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
  document.body.addEventListener('click', (e) => {
    const closeSel = e.target?.getAttribute('data-close');
    if (closeSel) {
      const m = document.querySelector(closeSel);
      if (m) {
        m.classList.remove('active');
        m.setAttribute('hidden', '');
      }
    }
  });

  loadTasks();
  // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–º–µ—Å—Ç–µ —Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–æ–ª–ª–∏–Ω–≥–æ–º
  const tmr = setInterval(loadTasks, 3000);
  window.addEventListener('beforeunload', () => clearInterval(tmr));
})();
</script>

<script>
    //–æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–º—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –ª–µ–Ω–¥–∞
(function() {
  const siteId = {{ site.id }};
  const selectedSubId = {{ selected_sub.id|default:"null" }};
  const promptEl = document.getElementById('correctionPrompt');
  const sendBtn = document.getElementById('sendCorrectionBtn');

  if (!promptEl || !sendBtn) return;

  let sending = false;

  function setSending(on) {
    sending = !!on;
    // –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –±–ª–æ–∫–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
    sendBtn.disabled = true;
    promptEl.disabled = true;

    const orig = sendBtn.getAttribute('data-orig') || sendBtn.textContent;
    if (!sendBtn.getAttribute('data-orig')) {
      sendBtn.setAttribute('data-orig', orig);
    }
    sendBtn.textContent = on ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : sendBtn.getAttribute('data-orig');
  }

  async function sendCorrection() {
    if (sending) return;

    // –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ (–∏–∑-–∑–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á) ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    if (sendBtn.disabled) return;

    const text = (promptEl.value || '').trim();
    if (!text) return;

    setSending(true);
    try {
      const resp = await fetch(`/sites/${siteId}/correction/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          prompt: text,
          sub_id: selectedSubId || null
        })
      });
      const data = await resp.json();

      if (data && data.ok) {
        // –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é ‚Äî –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        promptEl.value = '';
      } else {
        alert((data && data.error) || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å');
      }
    } catch (e) {
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ');
    } finally {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–ª–∏–Ω–≥—É:
      // –æ–Ω —Å–∞–º –≤–∫–ª—é—á–∞–µ—Ç/–æ—Ç–∫–ª—é—á–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á.
      setSending(false);
    }
  }

  // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
  sendBtn.addEventListener('click', sendCorrection);

  // Ctrl+Enter (Windows/Linux) –∏ Cmd+Enter (macOS)
  promptEl.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && (e.key === 'Enter' || e.code === 'Enter')) {
      e.preventDefault();
      sendCorrection();
    }
  });
})();
</script>


{% endblock %}