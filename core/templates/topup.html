{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞" %}{% endblock %}
{% block content %}

<h2>{% trans "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞" %}</h2>

<style>
  .chips { display:flex; gap:10px; flex-wrap:wrap; }
  .chip {
    padding:10px 12px; border-radius:12px;
    border:1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.03);
    cursor: pointer; user-select: none;
  }
  .chip.disabled { opacity: .4; cursor:not-allowed; }
  .chip.active {
    border-color: rgba(79,70,229,0.5);
    background: rgba(79,70,229,0.12);
    color: #c7d2fe;
  }
  .muted { color: var(--muted); }
  .section + .section { margin-top: 14px; }
</style>

<div class="card">
  <div class="section">
    <strong>1. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É</strong>
    <div class="muted" style="margin-top:4px;"></div>
    <div id="currencyList" class="chips" style="margin-top:8px;"></div>
  </div>

  <div class="section">
    <strong>2. –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ç—å</strong>
    <div class="muted" style="margin-top:4px;"></div>
    <div id="methodList" class="chips" style="margin-top:8px;"></div>
  </div>

  <div class="section" style="display:flex; gap:8px; align-items:center;">
    <input id="disclaimer" type="checkbox" />
    <label for="disclaimer" class="muted" style="cursor:pointer;">
      –°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è ¬´as is¬ª –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –±–µ—Ç–∞‚Äë—Ä–µ–∂–∏–º–µ. –û–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–æ.
    </label>
  </div>

  <div class="section" style="text-align:right;">
    <button id="topupBtn" class="btn btn-primary" disabled>–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
  </div>
</div>


{{ pgs|json_script:"pgs-data" }}
{{ currencies|json_script:"currencies-data" }}
{{ methods|json_script:"methods-data" }}

<script>
  // –î–∞–Ω–Ω—ã–µ —Å –±—ç–∫–∞
    const PGS = JSON.parse(document.getElementById('pgs-data').textContent);
    const currencies = JSON.parse(document.getElementById('currencies-data').textContent);
    const methods = JSON.parse(document.getElementById('methods-data').textContent);

  // –ü—Ä–æ—Å—Ç—ã–µ –∏–∫–æ–Ω–∫–∏
  const currencyIcon = {
    "USDT": "ü™ô"
  };
  const methodIcon = {
    "Tron": "‚ö°",
    "Ethereum": "üï∏"
  };

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ UI
  let selectedCurrency = null;
  let selectedMethod = null;

  function isPairAvailable(cur, met) {
    return PGS.some(x => x.currency === cur && x.method === met);
  }

  function renderCurrencies() {
    const box = document.getElementById('currencyList');
    box.innerHTML = '';
    currencies.forEach(cur => {
      const el = document.createElement('div');
      el.className = 'chip' + (selectedCurrency === cur ? ' active' : '');
      el.textContent = `${currencyIcon[cur] || 'üí±'} ${cur}`;
      el.addEventListener('click', () => {
        selectedCurrency = cur;
        // –µ—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –Ω–æ–≤–æ–π –≤–∞–ª—é—Ç—ã ‚Äî —Å–±—Ä–æ—Å–∏–º –≤—ã–±–æ—Ä
        if (selectedMethod && !isPairAvailable(selectedCurrency, selectedMethod)) {
          selectedMethod = null;
        }
        renderCurrencies();
        renderMethods();
        updateBtn();
      });
      box.appendChild(el);
    });
  }

  function renderMethods() {
    const box = document.getElementById('methodList');
    box.innerHTML = '';

    methods.forEach(met => {
      const available = !selectedCurrency || isPairAvailable(selectedCurrency, met);
      const el = document.createElement('div');
      el.className = 'chip' +
        (available ? '' : ' disabled') +
        (selectedMethod === met ? ' active' : '');

      el.textContent = `${methodIcon[met] || 'üåê'} ${met}`;
      if (available) {
        el.addEventListener('click', () => {
          selectedMethod = met;
          renderMethods();
          updateBtn();
        });
      }
      box.appendChild(el);
    });
  }

  function updateBtn() {
    const ok = !!(selectedCurrency && selectedMethod && document.getElementById('disclaimer').checked);
    document.getElementById('topupBtn').disabled = !ok;
  }

  document.getElementById('disclaimer').addEventListener('change', updateBtn);

  renderCurrencies();
  renderMethods();
  updateBtn();

  function postJSON(url, data) {
    return fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(data)
    }).then(r => r.json());
  }

  document.getElementById('topupBtn').addEventListener('click', async () => {
    if (!selectedCurrency || !selectedMethod) return;

    try {
      const resp = await postJSON('/api/topup/create/', {
        currency: selectedCurrency,
        method: selectedMethod,
        disclaimer: document.getElementById('disclaimer').checked
      });
      if (resp.status && resp.redirect) {
        window.location.href = resp.redirect;
      } else {
        alert(resp.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞');
      }
    } catch(e) {
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
  });
</script>
{% endblock %}
